<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GREEN REMODELING</title>

    <!-- 공통 → 컴포넌트 → 페이지 전용 -->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/ml-loader.css}">
    <link rel="stylesheet" th:href="@{/css/forecast.css}">
</head>

<body class="page-forecast">

<!-- 헤더 -->
<div th:replace="~{layouts/header :: header}"></div>

<!-- 헤더-스페이서: JS 비활성화 시에도 겹침 방지 -->
<div class="header-spacer" aria-hidden="true"></div>

<!-- 메인 -->
<main id="forecast-root" class="wrap"
      th:with="bid=${buildingId}"
      th:data-bid="${buildingId}"
      th:data-from="${fromYear}"
      th:data-to="${toYear}"
      th:data-built-year="${builtYear != null ? builtYear : ''}"
      th:data-pnu="${pnu != null ? pnu : ''}"
      th:data-use="${useName != null ? useName : ''}"
      th:data-area="${area != null ? area : ''}"
      th:data-plot-area="${plotArea != null ? plotArea : ''}"
      th:data-floors-above="${floorsAbove != null ? floorsAbove : ''}"
      th:data-floors-below="${floorsBelow != null ? floorsBelow : ''}"
      th:data-bname="${#strings.defaultString(buildingName, '')}"
      th:data-height="${height != null ? height : ''}"
      th:data-approval-date="${approvalDate != null ? approvalDate : ''}"
      th:data-dong-name="${dongName != null ? dongName : ''}"
      th:data-building-ident="${buildingIdent != null ? buildingIdent : ''}"
      th:data-lot-serial="${lotSerial != null ? lotSerial : ''}">

    <!-- 상단 연두 면(히어로) : 라운드 통일 -->
    <section class="hero-block">
        <div class="hero-inner">
            <div class="hero-text">
                <h1>GREEN REMODELING</h1><br><br>
                <h2>운영비는 낮추고,<br/>건물 가치는 높이는 가장 똑똑한 선택</h2><br>
                <p class="hero-desc">
                    데이터 기반 머신러닝으로 예상 비용 절감, 에너지 절감량, 투자 회수 기간을 예측합니다.
                </p>
            </div>
            <div class="hero-media video-card">
                <video
                        id="hero-video"
                        class="hero-video video-media"
                        autoplay
                        muted
                        loop
                        playsinline
                        preload="metadata"
                        aria-label="그린 리모델링 소개 영상"
                >
                    <source th:src="@{/video/solar2.mp4}" type="video/mp4" />
                    브라우저가 비디오를 지원하지 않습니다.
                </video>
            </div>
        </div>
    </section>

    <!-- ML 로딩 패널 (히어로와 폭/라운드 동일) -->
    <section
            id="mlLoader"
            class="ml-panel"
            role="region"
            aria-labelledby="mlLoaderTitle"
            aria-describedby="mlLoaderDesc"
    >
        <div class="ml-card fade-in">
            <div class="row">
                <div>
                    <div class="title" id="mlLoaderTitle">예측 계산 중…</div>
                    <div class="muted" id="mlLoaderDesc">에너지 사용량 & 비용을 머신러닝 모델로 산출하고 있습니다.</div>
                </div>
                <div class="right">
                    <div class="spinner" aria-hidden="true"></div>
                    <span class="muted" id="mlStatusText">초기화</span>
                </div>
            </div>

            <div class="spacer-12"></div>

            <div class="chips" aria-live="polite">
               <span class="chip" id="chip-model">
                  <span class="dot" aria-hidden="true"></span>
                  <strong>모델</strong><span class="sep" aria-hidden="true">:</span>
                  <span class="truncate" id="modelName">Linear Regression</span>
               </span>

                <span class="chip">
                  <span class="dot" aria-hidden="true"></span>
                  <strong>데이터</strong><span class="sep" aria-hidden="true">:</span>
                  <span class="truncate" id="meta-data-range">-</span>
               </span>

                <span class="chip">
                  <span class="dot" aria-hidden="true"></span>
                  <strong>특성</strong><span class="sep" aria-hidden="true">:</span>
                  <span class="truncate">연도, 사용량, 비용</span>
               </span>
            </div>

            <div class="progress">
                <div
                        class="progress-bar"
                        id="progressBar"
                        role="progressbar"
                        aria-label="예측 진행률"
                        aria-valuemin="0"
                        aria-valuemax="100"
                        aria-valuenow="0"
                        style="width:0%"
                ></div>
            </div>

            <div class="progress-map" id="progressMap">
                <div class="step">
                    <span class="check" data-step="1"></span>데이터 로딩
                </div>
                <div class="step">
                    <span class="check" data-step="2"></span>정규화 / 스케일링
                </div>
                <div class="step">
                    <span class="check" data-step="3"></span>모델 피팅
                </div>
                <div class="step">
                    <span class="check" data-step="4"></span>예측 / 검증
                </div>
                <div class="step">
                    <span class="check" data-step="5"></span>차트 렌더링
                </div>
            </div>

            <div class="divider"></div>
            <div class="row">
                <div class="small">완료 시 이 패널은 자동으로 닫히고 차트 애니메이션이 시작됩니다.</div>
            </div>
        </div>
    </section>

    <!-- 결과(로딩 끝난 후에만 노출) -->
    <section id="result-section" class="result hidden">

        <!-- 차트(연두 배경 제외) -->
        <section class="chart-card">
            <div class="chart-title">에너지 사용량 & 절감 (kWh/년)</div>
            <div id="chart-energy-wrap" class="chart-area">
                <canvas id="chart-energy-combo"></canvas>
            </div>
        </section>

        <!-- 여기부터 연두 배경: 카드 + 요약 + 배너 -->
        <div class="result-surface">

            <div class="section-heading">그린 리모델링 절감 효과</div>

            <!-- KPI 카드 (피그마 순서/라벨) -->
            <section class="kpis">
                <!-- 에너지 등급 -->
                <article class="kpi-card kpi-grade">
                    <div class="icon-wrap">
                     <span class="icon-bg">
                        <i class="icon icon-card1" aria-hidden="true"></i>
                     </span>
                    </div>
                    <div class="meta">
                        <div class="label">에너지 등급</div>
                        <div id="kpi-grade" class="value">-</div>
                        <div class="sub">EUI 기준 산출</div>
                    </div>
                </article>

                <!-- 절감 비용(원/년) -->
                <article class="kpi-card kpi-cost">
                    <div class="icon-wrap">
                     <span class="icon-bg">
                        <i class="icon icon-card2" aria-hidden="true"></i>
                     </span>
                    </div>
                    <div class="meta">
                        <div class="label">절감 비용(원/년)</div>
                        <div id="kpi-saving-cost" class="value">-</div>
                        <div class="sub">절감 에너지 × 단가</div>
                    </div>
                </article>

                <!-- 투자 회수 기간 -->
                <article class="kpi-card kpi-payback">
                    <div class="icon-wrap">
                     <span class="icon-bg">
                        <i class="icon icon-card3" aria-hidden="true"></i>
                     </span>
                    </div>
                    <div class="meta">
                        <div class="label">투자 회수 기간</div>
                        <div id="kpi-payback" class="value">-</div>
                        <div class="sub">단순 회수 기준</div>
                    </div>
                </article>

                <!-- 에너지 절감률(%) -->
                <article class="kpi-card kpi-pct">
                    <div class="icon-wrap">
                     <span class="icon-bg">
                        <i class="icon icon-card4" aria-hidden="true"></i>
                     </span>
                    </div>
                    <div class="meta">
                        <div class="label">에너지 절감률(%)</div>
                        <div id="kpi-saving-pct" class="value">-</div>
                        <div class="sub">면적당 사용량 기준</div>
                    </div>
                </article>
            </section>

            <!-- [ADD] 건물 정보 카드 컨테이너 -->
            <div id="building-card" class="hidden"></div>

            <!-- 결과 요약(피그마 고정 텍스트) -->
            <section class="summary card">
                <div class="summary-title-row">
                    <div class="summary-title">결과 요약</div>
                    <span class="summary-badge">계산 기준</span>
                </div>

                <ul id="summary-list" class="summary-list"></ul>

                <div class="summary-footnote">
                    * 예시 값이며 실제 건물 특성·요금제·운영 패턴에 따라 달라질 수 있습니다.
                </div>
            </section>

            <!-- 배너(피그마 고정 멘트) -->
            <div id="status-banner" class="banner recommend">
                <span id="banner-message">연식과 향후 비용 리스크를 고려할 때, 리모델링을 권장합니다.</span>
                <span id="banner-badge" class="badge">추천</span>
            </div>

        </div>
        <!-- /result-surface -->

    </section>

    <div id="page-data" th:data-building-id="${buildingId}" hidden></div>
</main>

<div th:replace="~{layouts/footer :: footer}"></div>

<!-- 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- 페이지 전용 스크립트(순서 중요!) -->
<script th:src="@{/js/vworldClient.js}"></script>
<script th:src="@{/js/forecast.kpi.js}"></script>

<!-- ★ 모델을 차트보다 먼저 로드 -->
<script th:src="@{/js/forecast.models.js}"></script>

<!-- 모델 다음에 차트/렌더 모듈 -->
<script th:src="@{/js/forecast.chart.js}"></script>

<!-- 데이터/로더/개발 도우미 -->
<script th:src="@{/js/forecast.providers.js}"></script>
<script th:src="@{/js/forecast.loader.js}"></script>
<script th:src="@{/js/forecast.vworld.dev.js}"></script>

<!-- 마지막에 메인 컨트롤러 -->
<script th:src="@{/js/forecast.main.js}"></script>

</body>
</html>
